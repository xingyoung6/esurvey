/*
Esurvey.min.js v1.3.0
The MIT License (MIT)
Copyright © 2022 <Xing_Young@163.com>
*/
function initSurvey(e,t){checkUniqueId(e);let n=[],l=document.querySelector(t);if(!l)throw Error("can not find the element:"+t);if(l.innerHTML="",e.settings.showHead){let r=document.createElement("div");r.setAttribute("class","survey-header"),r.style.paddingBottom="20px",l.appendChild(r);let a=document.createElement("h1");a.innerHTML=e.title,a.setAttribute("class","servey-title"),a.style.textAlign="center",a.style.paddingBottom="20px",r.appendChild(a);let s=document.createElement("p");s.innerHTML=e.introduction,s.setAttribute("class","servey-introduction"),s.style.textIndent="2rem",r.appendChild(s);let d=document.createElement("hr");d.style.width="100%",d.style.height="3px",d.style.color="#666",r.appendChild(d)}let o=document.createElement("form");if(o.setAttribute("class","survey-form"),o.id=e.settings.formId||"esurvey-form",o.method=e.settings.formMethod||"POST",o.action=e.settings.formAction||"",o.target=e.settings.formTarget||"",l.appendChild(o),e.questions.forEach(t=>{let l=document.createElement("div");l.className="mb-4",l.id="survey-question-box-"+t.id;let r=document.createElement("label");if(r.setAttribute("for","survey-question-"+t.id),r.className="form-label",r.style.fontSize="18px",r.style.lineHeight="48px",r.style.fontWeight="bolder",r.innerHTML=t.title,e.settings.showIndex&&(r.innerHTML=`${t.id}、${t.title}`),t.required){let a=document.createElement("span");a.innerHTML=" [必填]",a.style.fontWeight="lighter",a.style.color="#FF504F",r.appendChild(a)}if(l.appendChild(r),t.desc){let s=document.createElement("div");s.className="survey-question-desc mb-2",s.style.fontSize="13px",s.style.textIndent="2rem",s.style.color="#aaa",s.innerText=t.desc,l.appendChild(s)}"select"===t.type?addSelect(o,n,l,r,t):"radio"===t.type?addRadio(o,n,l,r,t):"multi-select"===t.type?addMultiSelect(o,n,l,r,t):"input"===t.type?addInput(o,n,l,r,t):"textarea"===t.type?addTextArea(o,n,l,r,t):"slider"===t.type&&addSlider(o,n,l,r,t);let d=document.createElement("span");d.id="survey-err-"+t.id,d.className="error-msg",d.style.color="red",d.style.fontSize="13px",d.style.position="absolute",l.appendChild(d);let u=document.createElement("hr");u.style.width="100%",u.style.height="1px",u.style.color="#666",o.appendChild(u)}),e.settings.submitBtn){let u=document.createElement("button");u.className="btn btn-outline-primary",u.innerHTML=e.settings.submitBtn.text||"提交表单",u.type="submit",o.appendChild(u)}document.getElementById(e.settings.formId||"esurvey-form").onsubmit=()=>{for(i=0,elemList=document.getElementsByClassName("error-msg");i<elemList.length;i++)elemList[i].innerHTML="";let e=!0;if(n.forEach(t=>{e=e&&t()}),!e)return!1}}function formFormatter(e){let t=document.querySelector(e);if(!t)throw Error("can not find the element:"+e);if("TEXTAREA"!==t.tagName)throw Error("formFormatter needs a <textarea> element!");let n={title:"",introduction:"",settings:{formId:null,formTarget:null,formMethod:null,showHead:null,submitBtn:null},questions:[]};return""===t.value.trim()||format(t,n),n}function format(e,t){let n={单选:"radio",下拉:"select",多选:"multi-select",填空:"input",文本:"textarea",量表:"slider"},l=e.value.split("\n\n");for(i=0,t.title=l.shift(),t.introduction=l.shift();i<l.length;i++){let r=l[i].split("\n"),a={id:i+1,name:"question"+(i+1).toString(),options:[]},s=r.shift(),d=RegExp("【.+】").exec(s);d=d?d[0].slice(1,-1):"单选";let o=!!/@R$/.exec(s);if("量表"===d){let u=RegExp("{.+}").exec(s);u?(u=u[0].slice(1,-1).split("/"),a.minText=u[0],a.min=u[1],a.maxText=u[2],a.max=u[3]):(a.minText="请配置量表",a.maxText="请配置量表")}for(j=0,s=s.replace(/【.*】/,"").replace(/@R$/,"").replace(/{.*}/,""),a.title=s,a.type=n[d],a.required=o;j<r.length;j++){let m=RegExp("@[0-9]+$").exec(r[j]);r[j]=r[j].replace(/@[0-9]*$/,""),a.options.push({id:j+1,value:m?m[0].slice(1):j+1,label:r[j]})}t.questions.push(a)}}function debounce(e,t){let n=null;return function(){null!==n&&clearTimeout(n),n=setTimeout(e,t)}}function checkUniqueId(e){let t={};e.questions.forEach(e=>{if(t[e.id])throw Error(`A question need a unique id! But the question titled "${e.title}" has a repeated id`);t[e.id]=!0})}function addSelect(e,t,n,l,r){let a=document.createElement("select");a.required=r.required,a.id="survey-question-"+r.id,a.name=r.name||"survey-question-"+r.id,a.className="form-select",a.setAttribute("aria-label","survey-select-item");let s=document.createElement("option");s.innerHTML="点击下拉选择",s.setAttribute("selected","true"),s.value="",a.appendChild(s),r.options.forEach(e=>{let t=document.createElement("option");t.innerHTML=e.label,t.value=e.value,a.appendChild(t)}),n.appendChild(a),e.appendChild(n)}function addRadio(e,t,n,l,r){n.className="mb-4 check-group",l.removeAttribute("for");let a=document.createElement("div");a.className="check-list mx-4 row",r.options.forEach(e=>{let t=document.createElement("div");t.className="form-check col-md-6 col-xxl-3 mb-3 mb-xxl-0";let n=document.createElement("input");n.className="form-check-input",n.type="radio",n.id="survey-question-"+r.id+"-option-"+e.id,n.name=r.name||"survey-question-"+r.id,n.value=e.value;let l=document.createElement("label");l.innerHTML=e.label,l.className="form-check-label",l.style.height="40px",l.style.width="100%",l.style.position="relative",l.setAttribute("for","survey-question-"+r.id+"-option-"+e.id),t.appendChild(n),t.appendChild(l),a.appendChild(t)}),n.appendChild(a),e.appendChild(n),r.required&&t.push(()=>{let e=document.getElementsByName(r.name||"survey-question-"+r.id),t=!1;return e.forEach(e=>{t+=e.checked}),!!t||(document.getElementById("survey-err-"+r.id).innerText="本题为必填题目！",window.location.href="#survey-question-box-"+r.id,!1)})}function addMultiSelect(e,t,n,l,r){n.className="mb-4 check-group",l.removeAttribute("for");let a=document.createElement("div");a.className="check-list mx-4 row",r.options.forEach(e=>{let t=document.createElement("div");t.className="form-check col-sm-6 col-md-3 mb-3 mb-md-0";let n=document.createElement("input");n.className="form-check-input",n.type="checkbox",n.id="survey-question-"+r.id+"-option-"+e.id,n.name=r.name||"survey-question-"+r.id,n.value=e.value;let l=document.createElement("label");l.innerHTML=e.label,l.className="form-check-label",l.setAttribute("for","survey-question-"+r.id+"-option-"+e.id),t.appendChild(n),t.appendChild(l),a.appendChild(t)}),n.appendChild(a),e.appendChild(n),r.required&&t.push(()=>{let e=document.getElementsByName(r.name||"survey-question-"+r.id),t=!1;return e.forEach(e=>{t+=e.checked}),!!t||(document.getElementById("survey-err-"+r.id).innerText="本题为必填题目！",!1)})}function addInput(e,t,n,l,r){let a=document.createElement("input");a.required=r.required,a.id="survey-question-"+r.id,a.name=r.name||"survey-question-"+r.id,a.className="form-control",a.type=r.valueType||"text","number"===r.valueType?(a.setAttribute("min",r.min),a.setAttribute("max",r.max)):(a.setAttribute("min-length",r.min),a.setAttribute("max-length",r.max)),a.placeholder=r.placeholder||"请输入"+r.title,n.appendChild(a),e.appendChild(n)}function addTextArea(e,t,n,l,r){let a=document.createElement("textarea");a.required=r.required,a.id="survey-question-"+r.id,a.name=r.name||"survey-question-"+r.id,a.className="form-control",a.type=r.valueType||"text",a.setAttribute("min-length",r.min),a.setAttribute("max-length",r.max),a.placeholder=r.placeholder||"请输入"+r.title,a.rows=r.rows||3,a.style.resize="unset",n.appendChild(a),e.appendChild(n)}function addSlider(e,t,n,l,r){let a=document.createElement("input");a.required=r.required,a.id="survey-question-"+r.id,a.name=r.name||"survey-question-"+r.id,a.type="range",a.className="form-range",a.value=r.min,a.setAttribute("min",r.min),a.setAttribute("max",r.max),a.step=r.step||1;let s={};r.options&&r.options!=[]&&r.options.forEach(e=>{s[e.value]=e.label});let d=document.createElement("div");d.className="d-flex justify-content-between align-items-end";let o=document.createElement("span");o.innerText=r.minText+"("+r.min+")",o.style.fontSize="12px";let u=document.createElement("span");u.innerText=r.maxText+"("+r.max+")",u.style.fontSize="12px";let m=document.createElement("span");m.innerText=(s[r.min]?s[r.min]+"：":"")+r.min,m.id="survey-question-"+r.id+"-now-value",m.style.color="blue",m.style.fontSize="16px",d.appendChild(o),d.appendChild(m),d.appendChild(u),a.onchange=function(e){let t=s[e.target.value]?s[e.target.value]+"：":"";document.getElementById("survey-question-"+r.id+"-now-value").innerHTML=t+e.target.value},n.appendChild(d),n.appendChild(a),e.appendChild(n)}Object.defineProperty(HTMLFormElement.prototype,"jsondata",{get(){let e={},t=new FormData(this);return t.forEach((n,l)=>{e[l]||(e[l]=t.getAll(l).length>1?t.getAll(l):t.get(l))}),e}});
